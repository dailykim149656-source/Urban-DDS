# 구 단위 조회 확장 계획

## 1. 목표
- 현재 시/도 중심 조회를 `구(gu)` 단위까지 확장한다.
- `/api/region/summary`가 `서울 강남구`, `부산 해운대구` 같은 입력을 안정적으로 해석하도록 만든다.
- REALDATA(실거래가/건축물) 연동 시 구 단위 지역코드(`LAWD_CD`)를 사용해 지표를 생성한다.

## 2. 현재 상태
- 지역 해석은 `lib/adapters/regionDataAdapter.ts`의 내부 시드 기반이다.
- 시/도 단위는 동작 중이나, 구 단위는 일부/미지원 상태다.
- `tradeFacts`는 `lawdCode`만 있으면 조회 가능.
- `buildingFacts`는 `buildingLookup` 매핑이 없으면 `missing-lookup`으로 떨어진다.

## 3. 설계 원칙
- 1차는 정확도 우선: 구 단위 시드 테이블을 명시적으로 유지한다.
- 중복 구명(`중구`)은 상위 시/도 문맥이 없으면 보수적으로 처리한다.
- 실패 이유는 응답 메타로 노출한다(`buildingFactsStatus`처럼 추적 가능하게).

## 4. 구현 범위 (1차)
1. 서울 전 구 + 6대 광역시 주요 구 시드 추가
2. 주소 매칭 우선순위 강화
3. 구 단위 `lawdCode` 연결
4. F/E 빠른 선택 대상에 구 샘플 추가

## 5. 상세 작업

## 5.1 Region 시드 확장
- 파일: `lib/adapters/regionDataAdapter.ts`
- 추가 필드:
  - `level: 'gu'`
  - `parentRegionId` (예: `seoul`)
  - `lawdCode` (5자리)
  - `center` (구 중심 좌표)
- 데이터 구조:
  - `city seeds`
  - `gu seeds`
  - alias 인덱스 (`강남구`, `강남`, `gangnam-gu`)

## 5.2 매칭 로직
- 우선순위:
  1. 시/도+구 정확 일치
  2. 구 정확 일치 + 문맥 일치
  3. 부분 일치
- 중복 처리:
  - `중구` 단독 입력 시 모호성 처리 규칙 적용
  - 규칙 예: 서울 기본 우선 또는 400 에러 + 후보 제시(선택 필요)

## 5.3 REALDATA 연동
- `tradeFacts`
  - 구별 `lawdCode`로 월별 실거래 조회
- `buildingFacts`
  - 1차: 기존 fallback 유지
  - 2차: 구별 기본 `buildingLookup` seed 단계적 확장

## 5.4 UI 반영
- 파일: `app/page.tsx`
- Quick targets에 구 샘플 추가:
  - `서울 강남구`, `서울 마포구`, `부산 해운대구`, `대구 수성구` 등
- 조회 결과에 `level=gu` 표시

## 6. 검증 계획 (Terminal B)
1. 주소 입력 검증
- `서울 강남구`, `서울 마포구`, `부산 해운대구`, `인천 연수구`, `대전 유성구`
- 기대: `200`, `regionCode`가 구 식별자로 매핑

2. 지표 생성 검증
- 기대: `tradeFacts` 존재
- `buildingFacts` 미존재 시 `buildingFactsStatus`가 명시됨

3. 모호성 검증
- 입력: `중구`
- 기대: 정의한 규칙대로 일관된 응답

4. 분석 연동 검증
- 구 단위 summary 결과로 `/api/analysis/report` 호출
- 기대: `200`, `aiSource=gemini`

## 7. 완료 기준 (DoD)
- 구 단위 주소 10개 이상 샘플에서 `summary` 성공률 90% 이상
- 구 단위에서 `tradeFacts` 정상 생성
- 모호성 입력(`중구`) 처리 규칙이 문서와 실제 응답이 일치
- 분석 API까지 연동 통과

## 8. 리스크 및 대응
- 리스크: 구명 중복/별칭 다양성
  - 대응: alias 테이블 + 모호성 규칙 고정
- 리스크: 건축물 lookup 부재
  - 대응: status 노출 + 우선순위 지역부터 lookup 보강
- 리스크: 데이터 품질 편차
  - 대응: 응답에 sample size/상태 메타 제공

## 9. 단계별 일정(권장)
1. Day 1: 시드/매칭 로직 구현(서울 + 광역시 핵심 구)
2. Day 2: 검증 시나리오 통과 + UI 빠른 선택 반영
3. Day 3: 모호성 처리/누락 지역 보정 + 문서 확정
